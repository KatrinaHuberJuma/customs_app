


No_surtax_for_pre-cutoff_ - starting CBSA surtax test

 - 2026-02-18 09:16:38,659 - logic_logger - INFO

Logic Phase:		ROW LOGIC		(session=0x10cb299d0) (sqlalchemy before_flush)			 - 2026-02-18 09:16:38,662 - logic_logger - INFO
..SurtaxOrder[None] {Insert - client} id: None, order_number: TEST-JA-b734c58b, entry_date: 2025-12-15 00:00:00, ship_date: 2025-12-20 00:00:00, country_origin_id: 4, province_code_id: 9, total_customs_value: None, total_duty: None, total_surtax: None, total_pst_hst: None, total_amount_due: None, surtax_applicable: None, importer_name: Behave Test - Japan, broker_name: None  row: 0x10caed7e0  session: 0x10cb299d0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,663 - logic_logger - INFO
..SurtaxOrder[None] {server aggregate_defaults: total_customs_value total_duty total_surtax total_pst_hst total_amount_due } id: None, order_number: TEST-JA-b734c58b, entry_date: 2025-12-15 00:00:00, ship_date: 2025-12-20 00:00:00, country_origin_id: 4, province_code_id: 9, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: None, importer_name: Behave Test - Japan, broker_name: None  row: 0x10caed7e0  session: 0x10cb299d0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,665 - logic_logger - INFO
..SurtaxOrder[None] {Surtax Applicable: False (Ship Date: 2025-12-20, Date Check: False, Country Check: True, Cutoff: 2025-12-26)} id: None, order_number: TEST-JA-b734c58b, entry_date: 2025-12-15 00:00:00, ship_date: 2025-12-20 00:00:00, country_origin_id: 4, province_code_id: 9, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: None, importer_name: Behave Test - Japan, broker_name: None  row: 0x10caed7e0  session: 0x10cb299d0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,667 - logic_logger - INFO
..SurtaxOrder[None] {Formula surtax_applicable} id: None, order_number: TEST-JA-b734c58b, entry_date: 2025-12-15 00:00:00, ship_date: 2025-12-20 00:00:00, country_origin_id: 4, province_code_id: 9, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: False, importer_name: Behave Test - Japan, broker_name: None  row: 0x10caed7e0  session: 0x10cb299d0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,668 - logic_logger - INFO
Logic Phase:		COMMIT LOGIC		(session=0x10cb299d0)   										 - 2026-02-18 09:16:38,669 - logic_logger - INFO
Logic Phase:		AFTER_FLUSH LOGIC	(session=0x10cb299d0)   										 - 2026-02-18 09:16:38,670 - logic_logger - INFO

These Rules Fired (see Logic Phases, above, for actual order):		## - 2026-02-18 09:16:38,670 - logic_logger - INFO
  SurtaxOrder		## - 2026-02-18 09:16:38,670 - logic_logger - INFO
    1. Derive <class 'database.models.SurtaxOrder'>.surtax_applicable as Formula (1): <function>		## - 2026-02-18 09:16:38,670 - logic_logger - INFO

Logic Phase:		COMPLETE(session=0x10cb299d0))       	 - 2026-02-18 09:16:38,670 - logic_logger - INFO

Logic Phase:		ROW LOGIC		(session=0x10cb285a0) (sqlalchemy before_flush)			 - 2026-02-18 09:16:38,678 - logic_logger - INFO
..SurtaxLineItem[None] {Insert - client} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: None, duty_rate: None, duty_amount: None, surtax_rate: None, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,679 - logic_logger - INFO
..SurtaxLineItem[None] {copy_rules for role: hs_code_rate - duty_rate, surtax_rate} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: None, duty_rate: 0.0000, duty_amount: None, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,682 - logic_logger - INFO
..SurtaxLineItem[None] {Formula customs_value} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: None, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,683 - logic_logger - INFO
..SurtaxLineItem[None] {Formula duty_amount} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,683 - logic_logger - INFO
..SurtaxLineItem[None] {Surtax Amount: 0 (Applicable: False)} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,684 - logic_logger - INFO
..SurtaxLineItem[None] {Formula surtax_amount} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,684 - logic_logger - INFO
..SurtaxLineItem[None] {PST/HST Rate: 0.1497} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,685 - logic_logger - INFO
..SurtaxLineItem[None] {Formula pst_hst_rate} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: None, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,685 - logic_logger - INFO
..SurtaxLineItem[None] {Formula pst_hst_amount} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: None  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,686 - logic_logger - INFO
..SurtaxLineItem[None] {Formula total_amount} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,686 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_customs_value as Sum(SurtaxLineItem.customs_value Where  - None)} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,688 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_pst_hst as Sum(SurtaxLineItem.pst_hst_amount Where  - None)} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,688 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_amount_due as Sum(SurtaxLineItem.total_amount Where  - None)} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,689 - logic_logger - INFO
....SurtaxOrder[35] {Update - Adjusting surtax_order: total_customs_value, total_pst_hst, total_amount_due} id: 35, order_number: TEST-JA-b734c58b, entry_date: 2025-12-15, ship_date: 2025-12-20, country_origin_id: 4, province_code_id: 9, total_customs_value:  [0.00-->] 100000.00, total_duty: 0.00, total_surtax: 0.00, total_pst_hst:  [0.00-->] 14970.0000, total_amount_due:  [0.00-->] 114970.0000, surtax_applicable: False, importer_name: Behave Test - Japan, broker_name: None  row: 0x10caefba0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,689 - logic_logger - INFO
....SurtaxOrder[35] {Surtax Applicable: False (Ship Date: 2025-12-20, Date Check: False, Country Check: True, Cutoff: 2025-12-26)} id: 35, order_number: TEST-JA-b734c58b, entry_date: 2025-12-15, ship_date: 2025-12-20, country_origin_id: 4, province_code_id: 9, total_customs_value:  [0.00-->] 100000.00, total_duty: 0.00, total_surtax: 0.00, total_pst_hst:  [0.00-->] 14970.0000, total_amount_due:  [0.00-->] 114970.0000, surtax_applicable: False, importer_name: Behave Test - Japan, broker_name: None  row: 0x10caefba0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,691 - logic_logger - INFO
......SurtaxLineItem[None] {Update - Cascading surtax_order.province_tax_rate (,...)} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,693 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: customs_value [['quantity', 'unit_price']]} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,694 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: duty_amount [['customs_value', 'duty_rate']]} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,695 - logic_logger - INFO
......SurtaxLineItem[None] {Surtax Amount: 0 (Applicable: False)} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,695 - logic_logger - INFO
......SurtaxLineItem[None] {PST/HST Rate: 0.1497} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,696 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: pst_hst_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_rate']]} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,696 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: total_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_amount']]} id: None, surtax_order_id: 35, hs_code_id: 3, line_number: 1, description: Behave test item - 7213.91.00, quantity: 500, unit_of_measure: None, unit_price: 200, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 0, pst_hst_rate: 0.1497, pst_hst_amount: 14970.0000, total_amount: 114970.0000  row: 0x10cb082f0  session: 0x10cb285a0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,697 - logic_logger - INFO
Logic Phase:		COMMIT LOGIC		(session=0x10cb285a0)   										 - 2026-02-18 09:16:38,700 - logic_logger - INFO
Logic Phase:		AFTER_FLUSH LOGIC	(session=0x10cb285a0)   										 - 2026-02-18 09:16:38,702 - logic_logger - INFO

These Rules Fired (see Logic Phases, above, for actual order):		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
  SurtaxLineItem		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
    1. Derive <class 'database.models.SurtaxLineItem'>.duty_amount as Formula (2): as_expression=lambda row: row.customs_value * (ro [...]		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
    2. Derive <class 'database.models.SurtaxLineItem'>.pst_hst_rate as Formula (4): <function>		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
    3. Derive <class 'database.models.SurtaxLineItem'>.duty_rate as Copy(hs_code_rate.base_duty_rate)		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
    4. Derive <class 'database.models.SurtaxLineItem'>.surtax_rate as Copy(hs_code_rate.surtax_rate)		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
    5. Derive <class 'database.models.SurtaxLineItem'>.pst_hst_amount as Formula (5): as_expression=lambda row: (row.customs_value + (r [...]		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
    6. Derive <class 'database.models.SurtaxLineItem'>.total_amount as Formula (6): as_expression=lambda row: (row.customs_value + 
  [...]		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
    7. Derive <class 'database.models.SurtaxLineItem'>.surtax_amount as Formula (3): <function>		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
    8. Derive <class 'database.models.SurtaxLineItem'>.customs_value as Formula (1): as_expression=lambda row: row.quantity * row.unit [...]		## - 2026-02-18 09:16:38,703 - logic_logger - INFO
  SurtaxOrder		## - 2026-02-18 09:16:38,704 - logic_logger - INFO
    9. Derive <class 'database.models.SurtaxOrder'>.total_amount_due as Sum(SurtaxLineItem.total_amount Where  - None)		## - 2026-02-18 09:16:38,704 - logic_logger - INFO
    10. Derive <class 'database.models.SurtaxOrder'>.total_customs_value as Sum(SurtaxLineItem.customs_value Where  - None)		## - 2026-02-18 09:16:38,704 - logic_logger - INFO
    11. Derive <class 'database.models.SurtaxOrder'>.total_surtax as Sum(SurtaxLineItem.surtax_amount Where  - None)		## - 2026-02-18 09:16:38,704 - logic_logger - INFO
    12. Derive <class 'database.models.SurtaxOrder'>.surtax_applicable as Formula (1): <function>		## - 2026-02-18 09:16:38,704 - logic_logger - INFO
    13. Derive <class 'database.models.SurtaxOrder'>.total_pst_hst as Sum(SurtaxLineItem.pst_hst_amount Where  - None)		## - 2026-02-18 09:16:38,704 - logic_logger - INFO
    14. Derive <class 'database.models.SurtaxOrder'>.total_duty as Sum(SurtaxLineItem.duty_amount Where  - None)		## - 2026-02-18 09:16:38,704 - logic_logger - INFO

Logic Phase:		COMPLETE(session=0x10cb285a0))       	 - 2026-02-18 09:16:38,704 - logic_logger - INFO
