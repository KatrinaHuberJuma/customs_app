


Order_totals_roll_up_from - starting CBSA surtax test

 - 2026-02-18 09:16:38,801 - logic_logger - INFO

Logic Phase:		ROW LOGIC		(session=0x10cb29ae0) (sqlalchemy before_flush)			 - 2026-02-18 09:16:38,804 - logic_logger - INFO
..SurtaxOrder[None] {Insert - client} id: None, order_number: TEST-UN-e9b3a3fd, entry_date: 2025-12-20 00:00:00, ship_date: 2025-12-28 00:00:00, country_origin_id: 3, province_code_id: 6, total_customs_value: None, total_duty: None, total_surtax: None, total_pst_hst: None, total_amount_due: None, surtax_applicable: None, importer_name: Behave Test - United States, broker_name: None  row: 0x10cc318b0  session: 0x10cb29ae0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,805 - logic_logger - INFO
..SurtaxOrder[None] {server aggregate_defaults: total_customs_value total_duty total_surtax total_pst_hst total_amount_due } id: None, order_number: TEST-UN-e9b3a3fd, entry_date: 2025-12-20 00:00:00, ship_date: 2025-12-28 00:00:00, country_origin_id: 3, province_code_id: 6, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: None, importer_name: Behave Test - United States, broker_name: None  row: 0x10cc318b0  session: 0x10cb29ae0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,807 - logic_logger - INFO
..SurtaxOrder[None] {Surtax Applicable: True (Ship Date: 2025-12-28, Date Check: True, Country Check: True, Cutoff: 2025-12-26)} id: None, order_number: TEST-UN-e9b3a3fd, entry_date: 2025-12-20 00:00:00, ship_date: 2025-12-28 00:00:00, country_origin_id: 3, province_code_id: 6, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: None, importer_name: Behave Test - United States, broker_name: None  row: 0x10cc318b0  session: 0x10cb29ae0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,810 - logic_logger - INFO
..SurtaxOrder[None] {Formula surtax_applicable} id: None, order_number: TEST-UN-e9b3a3fd, entry_date: 2025-12-20 00:00:00, ship_date: 2025-12-28 00:00:00, country_origin_id: 3, province_code_id: 6, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: True, importer_name: Behave Test - United States, broker_name: None  row: 0x10cc318b0  session: 0x10cb29ae0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,810 - logic_logger - INFO
Logic Phase:		COMMIT LOGIC		(session=0x10cb29ae0)   										 - 2026-02-18 09:16:38,811 - logic_logger - INFO
Logic Phase:		AFTER_FLUSH LOGIC	(session=0x10cb29ae0)   										 - 2026-02-18 09:16:38,812 - logic_logger - INFO

These Rules Fired (see Logic Phases, above, for actual order):		## - 2026-02-18 09:16:38,813 - logic_logger - INFO
  SurtaxOrder		## - 2026-02-18 09:16:38,813 - logic_logger - INFO
    1. Derive <class 'database.models.SurtaxOrder'>.surtax_applicable as Formula (1): <function>		## - 2026-02-18 09:16:38,813 - logic_logger - INFO

Logic Phase:		COMPLETE(session=0x10cb29ae0))       	 - 2026-02-18 09:16:38,813 - logic_logger - INFO

Logic Phase:		ROW LOGIC		(session=0x10cb297b0) (sqlalchemy before_flush)			 - 2026-02-18 09:16:38,820 - logic_logger - INFO
..SurtaxLineItem[None] {Insert - client} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: None, duty_rate: None, duty_amount: None, surtax_rate: None, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,821 - logic_logger - INFO
..SurtaxLineItem[None] {copy_rules for role: hs_code_rate - duty_rate, surtax_rate} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: None, duty_rate: 0.0000, duty_amount: None, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,824 - logic_logger - INFO
..SurtaxLineItem[None] {Formula customs_value} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: None, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,825 - logic_logger - INFO
..SurtaxLineItem[None] {Formula duty_amount} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,825 - logic_logger - INFO
..SurtaxLineItem[None] {Surtax Amount: 25000.0000 (Applicable: True)} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,826 - logic_logger - INFO
..SurtaxLineItem[None] {Formula surtax_amount} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,826 - logic_logger - INFO
..SurtaxLineItem[None] {PST/HST Rate: 0.1200} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,827 - logic_logger - INFO
..SurtaxLineItem[None] {Formula pst_hst_rate} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: None, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,827 - logic_logger - INFO
..SurtaxLineItem[None] {Formula pst_hst_amount} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: None  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,828 - logic_logger - INFO
..SurtaxLineItem[None] {Formula total_amount} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,828 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_customs_value as Sum(SurtaxLineItem.customs_value Where  - None)} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,830 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_surtax as Sum(SurtaxLineItem.surtax_amount Where  - None)} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,830 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_pst_hst as Sum(SurtaxLineItem.pst_hst_amount Where  - None)} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,830 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_amount_due as Sum(SurtaxLineItem.total_amount Where  - None)} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,831 - logic_logger - INFO
....SurtaxOrder[37] {Update - Adjusting surtax_order: total_customs_value, total_surtax, total_pst_hst, total_amount_due} id: 37, order_number: TEST-UN-e9b3a3fd, entry_date: 2025-12-20, ship_date: 2025-12-28, country_origin_id: 3, province_code_id: 6, total_customs_value:  [0.00-->] 100000.00, total_duty: 0.00, total_surtax:  [0.00-->] 25000.0000, total_pst_hst:  [0.00-->] 15000.00000000, total_amount_due:  [0.00-->] 140000.00000000, surtax_applicable: True, importer_name: Behave Test - United States, broker_name: None  row: 0x10caef790  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,831 - logic_logger - INFO
....SurtaxOrder[37] {Surtax Applicable: True (Ship Date: 2025-12-28, Date Check: True, Country Check: True, Cutoff: 2025-12-26)} id: 37, order_number: TEST-UN-e9b3a3fd, entry_date: 2025-12-20, ship_date: 2025-12-28, country_origin_id: 3, province_code_id: 6, total_customs_value:  [0.00-->] 100000.00, total_duty: 0.00, total_surtax:  [0.00-->] 25000.0000, total_pst_hst:  [0.00-->] 15000.00000000, total_amount_due:  [0.00-->] 140000.00000000, surtax_applicable: True, importer_name: Behave Test - United States, broker_name: None  row: 0x10caef790  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,832 - logic_logger - INFO
......SurtaxLineItem[None] {Update - Cascading surtax_order.province_tax_rate (,...)} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,835 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: customs_value [['quantity', 'unit_price']]} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,836 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: duty_amount [['customs_value', 'duty_rate']]} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,837 - logic_logger - INFO
......SurtaxLineItem[None] {Surtax Amount: 25000.0000 (Applicable: True)} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,837 - logic_logger - INFO
......SurtaxLineItem[None] {PST/HST Rate: 0.1200} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,838 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: pst_hst_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_rate']]} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,838 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: total_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_amount']]} id: None, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100, unit_of_measure: None, unit_price: 1000, customs_value: 100000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 25000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00000000, total_amount: 140000.00000000  row: 0x10cc3dfd0  session: 0x10cb297b0  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,839 - logic_logger - INFO
Logic Phase:		COMMIT LOGIC		(session=0x10cb297b0)   										 - 2026-02-18 09:16:38,842 - logic_logger - INFO
Logic Phase:		AFTER_FLUSH LOGIC	(session=0x10cb297b0)   										 - 2026-02-18 09:16:38,843 - logic_logger - INFO

These Rules Fired (see Logic Phases, above, for actual order):		## - 2026-02-18 09:16:38,844 - logic_logger - INFO
  SurtaxLineItem		## - 2026-02-18 09:16:38,844 - logic_logger - INFO
    1. Derive <class 'database.models.SurtaxLineItem'>.duty_amount as Formula (2): as_expression=lambda row: row.customs_value * (ro [...]		## - 2026-02-18 09:16:38,844 - logic_logger - INFO
    2. Derive <class 'database.models.SurtaxLineItem'>.pst_hst_rate as Formula (4): <function>		## - 2026-02-18 09:16:38,844 - logic_logger - INFO
    3. Derive <class 'database.models.SurtaxLineItem'>.duty_rate as Copy(hs_code_rate.base_duty_rate)		## - 2026-02-18 09:16:38,844 - logic_logger - INFO
    4. Derive <class 'database.models.SurtaxLineItem'>.surtax_rate as Copy(hs_code_rate.surtax_rate)		## - 2026-02-18 09:16:38,844 - logic_logger - INFO
    5. Derive <class 'database.models.SurtaxLineItem'>.pst_hst_amount as Formula (5): as_expression=lambda row: (row.customs_value + (r [...]		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    6. Derive <class 'database.models.SurtaxLineItem'>.total_amount as Formula (6): as_expression=lambda row: (row.customs_value + 
  [...]		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    7. Derive <class 'database.models.SurtaxLineItem'>.surtax_amount as Formula (3): <function>		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    8. Derive <class 'database.models.SurtaxLineItem'>.customs_value as Formula (1): as_expression=lambda row: row.quantity * row.unit [...]		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
  SurtaxOrder		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    9. Derive <class 'database.models.SurtaxOrder'>.total_amount_due as Sum(SurtaxLineItem.total_amount Where  - None)		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    10. Derive <class 'database.models.SurtaxOrder'>.total_customs_value as Sum(SurtaxLineItem.customs_value Where  - None)		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    11. Derive <class 'database.models.SurtaxOrder'>.total_surtax as Sum(SurtaxLineItem.surtax_amount Where  - None)		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    12. Derive <class 'database.models.SurtaxOrder'>.surtax_applicable as Formula (1): <function>		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    13. Derive <class 'database.models.SurtaxOrder'>.total_pst_hst as Sum(SurtaxLineItem.pst_hst_amount Where  - None)		## - 2026-02-18 09:16:38,845 - logic_logger - INFO
    14. Derive <class 'database.models.SurtaxOrder'>.total_duty as Sum(SurtaxLineItem.duty_amount Where  - None)		## - 2026-02-18 09:16:38,845 - logic_logger - INFO

Logic Phase:		COMPLETE(session=0x10cb297b0))       	 - 2026-02-18 09:16:38,845 - logic_logger - INFO

Logic Phase:		ROW LOGIC		(session=0x10cb29e10) (sqlalchemy before_flush)			 - 2026-02-18 09:16:38,853 - logic_logger - INFO
..SurtaxLineItem[None] {Insert - client} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: None, duty_rate: None, duty_amount: None, surtax_rate: None, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,854 - logic_logger - INFO
..SurtaxLineItem[None] {copy_rules for role: hs_code_rate - duty_rate, surtax_rate} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: None, duty_rate: 0.0000, duty_amount: None, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,857 - logic_logger - INFO
..SurtaxLineItem[None] {Formula customs_value} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: None, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,857 - logic_logger - INFO
..SurtaxLineItem[None] {Formula duty_amount} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,858 - logic_logger - INFO
..SurtaxLineItem[None] {Surtax Amount: 10000.0000 (Applicable: True)} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,858 - logic_logger - INFO
..SurtaxLineItem[None] {Formula surtax_amount} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,859 - logic_logger - INFO
..SurtaxLineItem[None] {PST/HST Rate: 0.1200} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,860 - logic_logger - INFO
..SurtaxLineItem[None] {Formula pst_hst_rate} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: None, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,860 - logic_logger - INFO
..SurtaxLineItem[None] {Formula pst_hst_amount} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: None  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,860 - logic_logger - INFO
..SurtaxLineItem[None] {Formula total_amount} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,861 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_customs_value as Sum(SurtaxLineItem.customs_value Where  - None)} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,862 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_surtax as Sum(SurtaxLineItem.surtax_amount Where  - None)} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,863 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_pst_hst as Sum(SurtaxLineItem.pst_hst_amount Where  - None)} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,863 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_amount_due as Sum(SurtaxLineItem.total_amount Where  - None)} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,864 - logic_logger - INFO
....SurtaxOrder[37] {Update - Adjusting surtax_order: total_customs_value, total_surtax, total_pst_hst, total_amount_due} id: 37, order_number: TEST-UN-e9b3a3fd, entry_date: 2025-12-20, ship_date: 2025-12-28, country_origin_id: 3, province_code_id: 6, total_customs_value:  [100000.00-->] 140000.00, total_duty: 0.00, total_surtax:  [25000.00-->] 35000.0000, total_pst_hst:  [15000.00-->] 21000.00000000, total_amount_due:  [140000.00-->] 196000.00000000, surtax_applicable: True, importer_name: Behave Test - United States, broker_name: None  row: 0x10caed710  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,864 - logic_logger - INFO
....SurtaxOrder[37] {Surtax Applicable: True (Ship Date: 2025-12-28, Date Check: True, Country Check: True, Cutoff: 2025-12-26)} id: 37, order_number: TEST-UN-e9b3a3fd, entry_date: 2025-12-20, ship_date: 2025-12-28, country_origin_id: 3, province_code_id: 6, total_customs_value:  [100000.00-->] 140000.00, total_duty: 0.00, total_surtax:  [25000.00-->] 35000.0000, total_pst_hst:  [15000.00-->] 21000.00000000, total_amount_due:  [140000.00-->] 196000.00000000, surtax_applicable: True, importer_name: Behave Test - United States, broker_name: None  row: 0x10caed710  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,865 - logic_logger - INFO
......SurtaxLineItem[30] {Update - Cascading surtax_order.province_tax_rate (,...)} id: 30, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100.000, unit_of_measure: KG, unit_price: 1000.00, customs_value: 100000.00, duty_rate: 0.0000, duty_amount: 0.00, surtax_rate: 0.2500, surtax_amount: 25000.00, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00, total_amount: 140000.00  row: 0x10cb27a10  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,868 - logic_logger - INFO
......SurtaxLineItem[30] {Prune Formula: customs_value [['quantity', 'unit_price']]} id: 30, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100.000, unit_of_measure: KG, unit_price: 1000.00, customs_value: 100000.00, duty_rate: 0.0000, duty_amount: 0.00, surtax_rate: 0.2500, surtax_amount: 25000.00, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00, total_amount: 140000.00  row: 0x10cb27a10  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,869 - logic_logger - INFO
......SurtaxLineItem[30] {Prune Formula: duty_amount [['customs_value', 'duty_rate']]} id: 30, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100.000, unit_of_measure: KG, unit_price: 1000.00, customs_value: 100000.00, duty_rate: 0.0000, duty_amount: 0.00, surtax_rate: 0.2500, surtax_amount: 25000.00, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00, total_amount: 140000.00  row: 0x10cb27a10  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,870 - logic_logger - INFO
......SurtaxLineItem[30] {Surtax Amount: 25000.000000 (Applicable: True)} id: 30, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100.000, unit_of_measure: KG, unit_price: 1000.00, customs_value: 100000.00, duty_rate: 0.0000, duty_amount: 0.00, surtax_rate: 0.2500, surtax_amount: 25000.00, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00, total_amount: 140000.00  row: 0x10cb27a10  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,870 - logic_logger - INFO
......SurtaxLineItem[30] {PST/HST Rate: 0.1200} id: 30, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100.000, unit_of_measure: KG, unit_price: 1000.00, customs_value: 100000.00, duty_rate: 0.0000, duty_amount: 0.00, surtax_rate: 0.2500, surtax_amount: 25000.00, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00, total_amount: 140000.00  row: 0x10cb27a10  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,871 - logic_logger - INFO
......SurtaxLineItem[30] {Prune Formula: pst_hst_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_rate']]} id: 30, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100.000, unit_of_measure: KG, unit_price: 1000.00, customs_value: 100000.00, duty_rate: 0.0000, duty_amount: 0.00, surtax_rate: 0.2500, surtax_amount: 25000.00, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00, total_amount: 140000.00  row: 0x10cb27a10  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,871 - logic_logger - INFO
......SurtaxLineItem[30] {Prune Formula: total_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_amount']]} id: 30, surtax_order_id: 37, hs_code_id: 5, line_number: 1, description: Behave test item - 7304.31.00, quantity: 100.000, unit_of_measure: KG, unit_price: 1000.00, customs_value: 100000.00, duty_rate: 0.0000, duty_amount: 0.00, surtax_rate: 0.2500, surtax_amount: 25000.00, pst_hst_rate: 0.1200, pst_hst_amount: 15000.00, total_amount: 140000.00  row: 0x10cb27a10  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,872 - logic_logger - INFO
......SurtaxLineItem[None] {Update - Cascading surtax_order.province_tax_rate (,...)} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,874 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: customs_value [['quantity', 'unit_price']]} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,875 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: duty_amount [['customs_value', 'duty_rate']]} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,876 - logic_logger - INFO
......SurtaxLineItem[None] {Surtax Amount: 10000.0000 (Applicable: True)} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,876 - logic_logger - INFO
......SurtaxLineItem[None] {PST/HST Rate: 0.1200} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,877 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: pst_hst_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_rate']]} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,877 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: total_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_amount']]} id: None, surtax_order_id: 37, hs_code_id: 6, line_number: 2, description: Behave test item - 7306.30.00, quantity: 50, unit_of_measure: None, unit_price: 800, customs_value: 40000, duty_rate: 0.0000, duty_amount: 0, surtax_rate: 0.2500, surtax_amount: 10000.0000, pst_hst_rate: 0.1200, pst_hst_amount: 6000.00000000, total_amount: 56000.00000000  row: 0x10cc3f770  session: 0x10cb29e10  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,878 - logic_logger - INFO
Logic Phase:		COMMIT LOGIC		(session=0x10cb29e10)   										 - 2026-02-18 09:16:38,882 - logic_logger - INFO
Logic Phase:		AFTER_FLUSH LOGIC	(session=0x10cb29e10)   										 - 2026-02-18 09:16:38,883 - logic_logger - INFO

These Rules Fired (see Logic Phases, above, for actual order):		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
  SurtaxLineItem		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    1. Derive <class 'database.models.SurtaxLineItem'>.duty_amount as Formula (2): as_expression=lambda row: row.customs_value * (ro [...]		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    2. Derive <class 'database.models.SurtaxLineItem'>.pst_hst_rate as Formula (4): <function>		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    3. Derive <class 'database.models.SurtaxLineItem'>.duty_rate as Copy(hs_code_rate.base_duty_rate)		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    4. Derive <class 'database.models.SurtaxLineItem'>.surtax_rate as Copy(hs_code_rate.surtax_rate)		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    5. Derive <class 'database.models.SurtaxLineItem'>.pst_hst_amount as Formula (5): as_expression=lambda row: (row.customs_value + (r [...]		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    6. Derive <class 'database.models.SurtaxLineItem'>.total_amount as Formula (6): as_expression=lambda row: (row.customs_value + 
  [...]		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    7. Derive <class 'database.models.SurtaxLineItem'>.surtax_amount as Formula (3): <function>		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    8. Derive <class 'database.models.SurtaxLineItem'>.customs_value as Formula (1): as_expression=lambda row: row.quantity * row.unit [...]		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
  SurtaxOrder		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    9. Derive <class 'database.models.SurtaxOrder'>.total_amount_due as Sum(SurtaxLineItem.total_amount Where  - None)		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    10. Derive <class 'database.models.SurtaxOrder'>.total_customs_value as Sum(SurtaxLineItem.customs_value Where  - None)		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    11. Derive <class 'database.models.SurtaxOrder'>.total_surtax as Sum(SurtaxLineItem.surtax_amount Where  - None)		## - 2026-02-18 09:16:38,884 - logic_logger - INFO
    12. Derive <class 'database.models.SurtaxOrder'>.surtax_applicable as Formula (1): <function>		## - 2026-02-18 09:16:38,885 - logic_logger - INFO
    13. Derive <class 'database.models.SurtaxOrder'>.total_pst_hst as Sum(SurtaxLineItem.pst_hst_amount Where  - None)		## - 2026-02-18 09:16:38,885 - logic_logger - INFO
    14. Derive <class 'database.models.SurtaxOrder'>.total_duty as Sum(SurtaxLineItem.duty_amount Where  - None)		## - 2026-02-18 09:16:38,885 - logic_logger - INFO

Logic Phase:		COMPLETE(session=0x10cb29e10))       	 - 2026-02-18 09:16:38,885 - logic_logger - INFO
