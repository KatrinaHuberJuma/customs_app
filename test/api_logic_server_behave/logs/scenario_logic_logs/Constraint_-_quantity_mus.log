


Constraint_-_quantity_mus - starting CBSA surtax test

 - 2026-02-18 09:16:38,947 - logic_logger - INFO

Logic Phase:		ROW LOGIC		(session=0x10cb28c00) (sqlalchemy before_flush)			 - 2026-02-18 09:16:38,950 - logic_logger - INFO
..SurtaxOrder[None] {Insert - client} id: None, order_number: TEST-GE-e44e44ff, entry_date: 2026-01-20 00:00:00, ship_date: 2026-02-01 00:00:00, country_origin_id: 2, province_code_id: 1, total_customs_value: None, total_duty: None, total_surtax: None, total_pst_hst: None, total_amount_due: None, surtax_applicable: None, importer_name: Behave Test - Germany, broker_name: None  row: 0x10cc31b20  session: 0x10cb28c00  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,950 - logic_logger - INFO
..SurtaxOrder[None] {server aggregate_defaults: total_customs_value total_duty total_surtax total_pst_hst total_amount_due } id: None, order_number: TEST-GE-e44e44ff, entry_date: 2026-01-20 00:00:00, ship_date: 2026-02-01 00:00:00, country_origin_id: 2, province_code_id: 1, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: None, importer_name: Behave Test - Germany, broker_name: None  row: 0x10cc31b20  session: 0x10cb28c00  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,953 - logic_logger - INFO
..SurtaxOrder[None] {Surtax Applicable: True (Ship Date: 2026-02-01, Date Check: True, Country Check: True, Cutoff: 2025-12-26)} id: None, order_number: TEST-GE-e44e44ff, entry_date: 2026-01-20 00:00:00, ship_date: 2026-02-01 00:00:00, country_origin_id: 2, province_code_id: 1, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: None, importer_name: Behave Test - Germany, broker_name: None  row: 0x10cc31b20  session: 0x10cb28c00  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,955 - logic_logger - INFO
..SurtaxOrder[None] {Formula surtax_applicable} id: None, order_number: TEST-GE-e44e44ff, entry_date: 2026-01-20 00:00:00, ship_date: 2026-02-01 00:00:00, country_origin_id: 2, province_code_id: 1, total_customs_value: 0, total_duty: 0, total_surtax: 0, total_pst_hst: 0, total_amount_due: 0, surtax_applicable: True, importer_name: Behave Test - Germany, broker_name: None  row: 0x10cc31b20  session: 0x10cb28c00  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,956 - logic_logger - INFO
Logic Phase:		COMMIT LOGIC		(session=0x10cb28c00)   										 - 2026-02-18 09:16:38,957 - logic_logger - INFO
Logic Phase:		AFTER_FLUSH LOGIC	(session=0x10cb28c00)   										 - 2026-02-18 09:16:38,958 - logic_logger - INFO

These Rules Fired (see Logic Phases, above, for actual order):		## - 2026-02-18 09:16:38,959 - logic_logger - INFO
  SurtaxOrder		## - 2026-02-18 09:16:38,959 - logic_logger - INFO
    1. Derive <class 'database.models.SurtaxOrder'>.surtax_applicable as Formula (1): <function>		## - 2026-02-18 09:16:38,959 - logic_logger - INFO

Logic Phase:		COMPLETE(session=0x10cb28c00))       	 - 2026-02-18 09:16:38,959 - logic_logger - INFO

Logic Phase:		ROW LOGIC		(session=0x10cb28160) (sqlalchemy before_flush)			 - 2026-02-18 09:16:38,967 - logic_logger - INFO
..SurtaxLineItem[None] {Insert - client} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: None, duty_rate: None, duty_amount: None, surtax_rate: None, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,968 - logic_logger - INFO
..SurtaxLineItem[None] {copy_rules for role: hs_code_rate - duty_rate, surtax_rate} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: None, duty_rate: 0.0000, duty_amount: None, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,970 - logic_logger - INFO
..SurtaxLineItem[None] {Formula customs_value} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: None, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,971 - logic_logger - INFO
..SurtaxLineItem[None] {Formula duty_amount} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,972 - logic_logger - INFO
..SurtaxLineItem[None] {Surtax Amount: -250.0000 (Applicable: True)} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: None, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,972 - logic_logger - INFO
..SurtaxLineItem[None] {Formula surtax_amount} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,973 - logic_logger - INFO
..SurtaxLineItem[None] {PST/HST Rate: 0.1300} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: None, pst_hst_amount: None, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,974 - logic_logger - INFO
..SurtaxLineItem[None] {Formula pst_hst_rate} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: None, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,974 - logic_logger - INFO
..SurtaxLineItem[None] {Formula pst_hst_amount} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: None  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,975 - logic_logger - INFO
..SurtaxLineItem[None] {Formula total_amount} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,975 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_customs_value as Sum(SurtaxLineItem.customs_value Where  - None)} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,976 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_surtax as Sum(SurtaxLineItem.surtax_amount Where  - None)} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,977 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_pst_hst as Sum(SurtaxLineItem.pst_hst_amount Where  - None)} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,977 - logic_logger - INFO
..SurtaxLineItem[None] {TODO DB adjust_from_inserted/adopted_child adjusts Derive <class 'database.models.SurtaxOrder'>.total_amount_due as Sum(SurtaxLineItem.total_amount Where  - None)} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: ins, initial: ins - 2026-02-18 09:16:38,978 - logic_logger - INFO
....SurtaxOrder[38] {Update - Adjusting surtax_order: total_customs_value, total_surtax, total_pst_hst, total_amount_due} id: 38, order_number: TEST-GE-e44e44ff, entry_date: 2026-01-20, ship_date: 2026-02-01, country_origin_id: 2, province_code_id: 1, total_customs_value:  [0.00-->] -1000.00, total_duty: 0.00, total_surtax:  [0.00-->] -250.0000, total_pst_hst:  [0.00-->] -162.50000000, total_amount_due:  [0.00-->] -1412.50000000, surtax_applicable: True, importer_name: Behave Test - Germany, broker_name: None  row: 0x10cc331e0  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,978 - logic_logger - INFO
....SurtaxOrder[38] {Surtax Applicable: True (Ship Date: 2026-02-01, Date Check: True, Country Check: True, Cutoff: 2025-12-26)} id: 38, order_number: TEST-GE-e44e44ff, entry_date: 2026-01-20, ship_date: 2026-02-01, country_origin_id: 2, province_code_id: 1, total_customs_value:  [0.00-->] -1000.00, total_duty: 0.00, total_surtax:  [0.00-->] -250.0000, total_pst_hst:  [0.00-->] -162.50000000, total_amount_due:  [0.00-->] -1412.50000000, surtax_applicable: True, importer_name: Behave Test - Germany, broker_name: None  row: 0x10cc331e0  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,980 - logic_logger - INFO
......SurtaxLineItem[None] {Update - Cascading surtax_order.province_tax_rate (,...)} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,982 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: customs_value [['quantity', 'unit_price']]} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,983 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: duty_amount [['customs_value', 'duty_rate']]} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,984 - logic_logger - INFO
......SurtaxLineItem[None] {Surtax Amount: -250.0000 (Applicable: True)} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,984 - logic_logger - INFO
......SurtaxLineItem[None] {PST/HST Rate: 0.1300} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,985 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: pst_hst_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_rate']]} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,985 - logic_logger - INFO
......SurtaxLineItem[None] {Prune Formula: total_amount [['customs_value', 'duty_amount', 'surtax_amount', 'pst_hst_amount']]} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,985 - logic_logger - INFO
......SurtaxLineItem[None] {Constraint Failure: Quantity must be greater than zero} id: None, surtax_order_id: 38, hs_code_id: 1, line_number: 1, description: Behave test item - 7208.10.00, quantity: -10, unit_of_measure: None, unit_price: 100, customs_value: -1000, duty_rate: 0.0000, duty_amount: -0, surtax_rate: 0.2500, surtax_amount: -250.0000, pst_hst_rate: 0.1300, pst_hst_amount: -162.50000000, total_amount: -1412.50000000  row: 0x10cbaaf90  session: 0x10cb28160  ins_upd_dlt: upd, initial: upd - 2026-02-18 09:16:38,986 - logic_logger - INFO

These Rules Fired (see Logic Phases, above, for actual order):		## - 2026-02-18 09:16:38,986 - logic_logger - INFO
  SurtaxLineItem		## - 2026-02-18 09:16:38,986 - logic_logger - INFO
    1. Derive <class 'database.models.SurtaxLineItem'>.duty_amount as Formula (2): as_expression=lambda row: row.customs_value * (ro [...]		## - 2026-02-18 09:16:38,986 - logic_logger - INFO
    2. Derive <class 'database.models.SurtaxLineItem'>.pst_hst_rate as Formula (4): <function>		## - 2026-02-18 09:16:38,986 - logic_logger - INFO
    3. Constraint Function: None 		## - 2026-02-18 09:16:38,986 - logic_logger - INFO
    4. Derive <class 'database.models.SurtaxLineItem'>.duty_rate as Copy(hs_code_rate.base_duty_rate)		## - 2026-02-18 09:16:38,986 - logic_logger - INFO
    5. Derive <class 'database.models.SurtaxLineItem'>.surtax_rate as Copy(hs_code_rate.surtax_rate)		## - 2026-02-18 09:16:38,986 - logic_logger - INFO
    6. Derive <class 'database.models.SurtaxLineItem'>.pst_hst_amount as Formula (5): as_expression=lambda row: (row.customs_value + (r [...]		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    7. Derive <class 'database.models.SurtaxLineItem'>.total_amount as Formula (6): as_expression=lambda row: (row.customs_value + 
  [...]		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    8. Derive <class 'database.models.SurtaxLineItem'>.surtax_amount as Formula (3): <function>		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    9. Derive <class 'database.models.SurtaxLineItem'>.customs_value as Formula (1): as_expression=lambda row: row.quantity * row.unit [...]		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
  SurtaxOrder		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    10. Derive <class 'database.models.SurtaxOrder'>.total_amount_due as Sum(SurtaxLineItem.total_amount Where  - None)		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    11. Derive <class 'database.models.SurtaxOrder'>.total_customs_value as Sum(SurtaxLineItem.customs_value Where  - None)		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    12. Derive <class 'database.models.SurtaxOrder'>.total_surtax as Sum(SurtaxLineItem.surtax_amount Where  - None)		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    13. Derive <class 'database.models.SurtaxOrder'>.surtax_applicable as Formula (1): <function>		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    14. Derive <class 'database.models.SurtaxOrder'>.total_pst_hst as Sum(SurtaxLineItem.pst_hst_amount Where  - None)		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
    15. Derive <class 'database.models.SurtaxOrder'>.total_duty as Sum(SurtaxLineItem.duty_amount Where  - None)		## - 2026-02-18 09:16:38,987 - logic_logger - INFO
